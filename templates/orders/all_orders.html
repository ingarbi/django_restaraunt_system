{% extends 'main/base.html' %} {% block content %}
{% load static %}
<div class="container ms-2">
  <h2 class="text-center" >–í—Å–µ –∑–∞–∫–∞–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è <span id="current_date"></span> </h2>
  
  <link href="{% static 'css/all_order.css' %}" rel="stylesheet" />

  <!-- Container for pending orders -->
  <div id="orders-container">{% include 'orders/order_list.html' %}</div>

  <!-- Display delivered and cancelled orders as a list in a grid -->
<!-- Completed orders -->
<div class="row mt-4" id="completed-orders">
  <div class="col-12">
    <h3 class="mb-3">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
    <div class="row g-3">
      {% for order in orders %}
        {% if order.status == 'delivered' or order.status == 'cancelled' %}
          <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card border-2 shadow-sm h-100 rounded-4 overflow-hidden">
              
              <!-- Header -->
              <div class="card-header bg-dark d-flex justify-content-between align-items-center py-2">
                <h6 class="mb-0 fw-bold text-light">
                  –ó–∞–∫–∞–∑ ‚Ññ{{ order.get_human_readable_order_number }}
                </h6>
                
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>{{ order.created_at|date:"H:i" }}
                </small>
              </div>

              <!-- Body -->
              <div class="card-body py-3">
                <a href="{% url 'order_detail' order.id %}" class="text-decoration-none text-dark">
                  
                  <!-- Status -->
                  <div class="mb-2">
                    {% if order.status == 'delivered' %}
                      <span class="badge bg-success-subtle text-success">
                        –í—ã–ø–æ–ª–Ω–µ–Ω
                      </span>
                    {% elif order.status == 'cancelled' %}
                      <span class="badge bg-danger-subtle text-danger">
                        –û—Ç–º–µ–Ω—ë–Ω
                      </span>
                    {% endif %}
                    {% if order.paid %}
                        <span class="badge bg-success text-light">–û–ø–ª–∞—á–µ–Ω</span>
                    {% else %}
                        <span class="badge bg-danger text-light">–ù–µ –æ–ø–ª–∞—á–µ–Ω</span>
                    {% endif %}
                  </div>

                  <!-- Order type + Payment + Total -->
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">
                      {% if order.order_type == "dine_in" %}
                        <span class="badge bg-primary"><i class="bi bi-shop me-1"></i>–í –∑–∞–ª–µ</span>
                      {% elif order.order_type == "takeaway" %}
                        <span class="badge bg-warning text-dark"><i class="bi bi-bag-check me-1"></i>–ù–∞ –≤—ã–Ω–æ—Å</span>
                      {% elif order.order_type == "delivery" %}
                        <span class="badge bg-success"><i class="bi bi-truck me-1"></i>–î–æ—Å—Ç–∞–≤–∫–∞</span>
                      {% endif %}

                      {% if order.payment_type == "cash" %}
                        <i class="bi bi-cash-coin fs-5 text-success" title="–ù–∞–ª–∏—á–Ω—ã–µ"></i>
                      {% elif order.payment_type == "online" %}
                        <i class="bi bi-phone-fill fs-5 text-primary" title="–ü–µ—Ä–µ–≤–æ–¥"></i>
                      {% elif order.payment_type == "free" %}
                        <i class="bi bi-gift-fill fs-5 text-info" title="–ë–µ—Å–ø–ª–∞—Ç–Ω–æ"></i>
                      {% endif %}
                    </div>

                    <div class="fw-bold">
                      {{ order.total_sum|floatformat:"-3g" }} ‚ÇΩ
                    </div>
                  </div>

                  <!-- Contact -->
                  {% if order.order_type == "takeaway" or order.order_type == "delivery" %}
                    <p class="small text-muted mb-2">
                      üìû {{ order.phone_number|default:"–ù–µ—Ç –Ω–æ–º–µ—Ä–∞" }}
                    </p>
                  {% endif %}

                  {% comment %} <!-- Items -->
                  <ul class="list-unstyled small mb-0">
                    {% for item in order.items.all|slice:":3" %}
                      <li>‚Ä¢ {{ item.menu_item.name }} <span class="text-muted">x{{ item.quantity }}</span></li>
                    {% endfor %}
                    {% if order.items.all|length > 3 %}
                      <li class="text-muted fst-italic">+ –µ—â—ë...</li>
                    {% endif %}
                  </ul> {% endcomment %}
                </a>
              </div>

            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

</div>

<script>
  const socket = new WebSocket("ws://" + window.location.host + "/ws/orders/");

  socket.onmessage = function (event) {
    const data = JSON.parse(event.data);
    console.log(data);

    // Handle status change updates
    if (data.action === "status_change") {
      fetch("{% url 'all_orders' %}", {
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("orders-container").innerHTML = data.html;
        });

      if (notificationStatusSound) {
        notificationStatusSound.play().catch((error) => {
          console.error("Error playing sound:", error);
        });
      }
    }

    // Handle new order creation
    if (data.message === "new_order") {
      const ordersContainer = document.getElementById("orders-container");
      const order = data.order_data;

      // Dynamically create the new order card using JavaScript
      const card = document.createElement("div");
      card.className = "col-md-3 col-sm-4 col-6 mb-1";
      card.innerHTML = `
                <div class="card-order border border-secondary d-flex flex-column h-100 rounded-3" data-order-id="${
                  order.id
                }">
                    <div class="card-body flex-fill">
                        <h6 class="card-title">–ó–∞–∫–∞–∑ #${order.order_number}
                            ${
                              order.status === "done"
                                ? '<span class="badge bg-info">–ì–æ—Ç–æ–≤</span>'
                                : '<span class="badge bg-warning text-dark">–ì–æ—Ç–æ–≤–∏—Ç—Å—è –Ω–∞ –∫—É—Ö–Ω–µ</span>'
                            }
                        </h6>
                        <span class="card-text text-decoration-underline">${
                          order.created_at
                        }</span>
                        <span>${
                          order.order_type === "takeaway" ||
                          order.order_type === "delivery"
                            ? order.phone_number || "–ù–µ—Ç –Ω–æ–º–µ—Ä–∞"
                            : ""
                        }</span>
                        <ul class="list-unstyled mt-1 mb-1">
                            ${order.items
                              .map(
                                (item) =>
                                  `<li>${item.name} x ${item.quantity}</li>`
                              )
                              .join("")}
                            ${order.items.length > 3 ? "<li>–ï—â–µ...</li>" : ""}
                        </ul>
                    </div>
                    <div class="d-flex flex-row text-center justify-content-evenly mb-1">
                        ${
                          order.status === "done"
                            ? `
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal${order.id}">
                                –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                            <button type="button" class="btn btn-info btn-sm fw-bold text-light" data-bs-toggle="modal" data-bs-target="#deliverModal${order.id}">
                                –í—Ä—É—á–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        `
                            : `
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal${order.id}">
                                –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        `
                        }
                    </div>
                </div>
            `;
      ordersContainer.prepend(card); // Add the new card at the top of the container

      //     if (notificationSound) {
      //     notificationSound.play().catch(error => {
      //         console.error('Error playing sound:', error);
      //     });
      // }
      setTimeout(function () {
        fetch("{% url 'all_orders' %}", {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("orders-container").innerHTML = data.html;
          });
      }, 7000);
    }
  };

document.getElementById("current_date").innerHTML = new Date().toLocaleDateString('ru-RU');


</script>
{% endblock %}
